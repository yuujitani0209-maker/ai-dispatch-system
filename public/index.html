<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AI配車ボード</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <h1>AI配車ボード</h1>

  <h2>配車を作成</h2>
  <form id="dispatch-form">
    <input type="text" id="description" placeholder="説明" required>
    <input type="number" id="driverId" placeholder="ドライバーID（任意）">
    <button type="submit">配車を作成</button>
  </form>
  <ul id="dispatch-list"></ul>

  <h2>ドライバーを作成</h2>
  <form id="driver-form">
    <input type="text" id="driver-name" placeholder="ドライバー名" required>
    <input type="text" id="license-number" placeholder="免許番号" required>
    <button type="submit">ドライバーを作成</button>
  </form>
  <ul id="driver-list"></ul>

  <h2>請求書を作成</h2>
  <form id="invoice-form">
    <input type="number" id="invoice-dispatchId" placeholder="配車ID" required>
    <input type="number" id="amount" placeholder="金額" required>
    <input type="text" id="status" placeholder="ステータス" required>
    <button type="submit">請求書を作成</button>
  </form>
  <ul id="invoice-list"></ul>

  <script>
    const socket = io();

    async function fetchDispatches() {
      const res = await fetch('/api/dispatch/list');
      const data = await res.json();
      const listEl = document.getElementById('dispatch-list');
      listEl.innerHTML = '';
      data.dispatches.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.id}: ${JSON.stringify(item)}`;
        listEl.appendChild(li);
      });
    }

    async function fetchDrivers() {
      const res = await fetch('/api/driver/list');
      const data = await res.json();
      const listEl = document.getElementById('driver-list');
      listEl.innerHTML = '';
      data.drivers.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.id}: ${item.name} (${item.licenseNumber})`;
        listEl.appendChild(li);
      });
    }

    async function fetchInvoices() {
      const res = await fetch('/api/invoice/list');
      const data = await res.json();
      const listEl = document.getElementById('invoice-list');
      listEl.innerHTML = '';
      data.invoices.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.id}: ${item.dispatchId} - ${item.amount} (${item.status})`;
        listEl.appendChild(li);
      });
    }

    fetchDispatches();
    fetchDrivers();
    fetchInvoices();

    socket.on('board-updated', () => {
      fetchDispatches();
    });

    document.getElementById('dispatch-form').addEventListener('submit', async e => {
      e.preventDefault();
      const description = document.getElementById('description').value;
      const driverId = document.getElementById('driverId').value || null;
      await fetch('/api/dispatch/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description, driverId: driverId ? parseInt(driverId) : undefined })
      });
      document.getElementById('description').value = '';
      document.getElementById('driverId').value = '';
    });

    document.getElementById('driver-form').addEventListener('submit', async e => {
      e.preventDefault();
      const name = document.getElementById('driver-name').value;
      const licenseNumber = document.getElementById('license-number').value;
      await fetch('/api/driver/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, licenseNumber })
      });
      document.getElementById('driver-name').value = '';
      document.getElementById('license-number').value = '';
      fetchDrivers();
    });

    document.getElementById('invoice-form').addEventListener('submit', async e => {
      e.preventDefault();
      const dispatchId = parseInt(document.getElementById('invoice-dispatchId').value);
      const amount = parseFloat(document.getElementById('amount').value);
      const status = document.getElementById('status').value;
      await fetch('/api/invoice/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dispatchId, amount, status })
      });
      document.getElementById('invoice-dispatchId').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('status').value = '';
      fetchInvoices();
    });
  </script>
</body>
</html>
